# 数据库概论课程笔记

###### Author：Shuryne
###### Date：2020/03/24

教程
* 廖雪峰SQL教程
* 《数据库系统概念》

## 1. 廖雪峰SQL基础

* 关系模型
  * 主键：最好是自增BIGINT类型
  * 外键：实现一对一/一对多/多对多关系
  * 索引：建立索引提高查询速度
* 查询数据
  * select
  * where
  * order by
  * group by
  * limit offset
  * inner/outer join
* 修改数据
  * insert
  * update
  * delete
* 事务
  * Read Uncommitted：脏读
  * Read Committed：不可重复读
  * Repeatable Read：幻读，默认隔离级别
  * Serializable：事务串行执行
  

## 2. 数据库概论

### 第一讲 数据库系统简介

* 数据模型
  * ER模型
  * 关系模型
* 数据库应用
  * SQL
  * 数据库接口
  * 关系规范化
  * 事务
* 数据库管理
  * 事务处理
  * 存储系统
  * 查询处理
* 历史阶段
  * 人工管理
  * 文件系统：字符流
  * 数据库系统：结构化数据、数据独立性
* 数据模型
  * 层状、网状、对象模型
  * ER模型
  * 关系模型
* 数据库模式
  * 模式/内模式：物理独立性
  * 外模式/模式：逻辑独立性
  

### 第二讲 ER模型
* 概念模型
* 实体和联系构成ER模型
* ER设计为数据库设计的第一步
* ER基础
  * 超码、候选码、主码
  * 实体、联系、属性
* ER扩展
  * 弱实体
  * 特化、概化
  * 聚集：抽象高层实体
* ER模型和关系模型的相互转换


### 第三讲 关系模型
* 关系代数基本运算
  * 一元：选择、投影、更名
  * 多元：笛卡尔积、集合并、集合差
* 关系代数扩展运算
  * 集合交、连接、自然连接、外链接
* 包：允许重复



### 第四讲 SQL
* 数据定义
  * 表、临时表
  * 基本数据类型
  * 索引：
    * 提高查询效率、消耗空间、降低更新效率
    * 唯一性索引
    * 聚簇索引
    * 组合索引
* 数据查询
  * 嵌套子查询：in/some/all/exists
  * 集合：union/intersect/except
* 数据更新
  * drop/delete/truncate
  * update
  * insert
* T-SQL语句
  * 批处理、注释、局部变量、控制流、错误处理
* 存储过程
  * 程序在服务器中预编译并存储起来，提高执行效率
* 触发器
  * 当对数据库作修改时，自动执行

  
### 第五讲 关系规范化
* 范式
  * 1NF
  * 2NF：消除非主属性对码的部分依赖
  * 3NF：消除非主属性对码的传递依赖
  * BCNF：消除主属性对码的部分以及传递依赖
  * 4NF：消除非平凡多值依赖
* 范式判定
  * Armstrong公理
  * 候选码计算
  * 最小覆盖
* 模式分解
  * 保持无损连接分解
  * 保持函数依赖分解
  * 达到更高级范式

  
### 第六讲 事务
* 事务：commit/rollback
* 事务特性
  * 原子性：恢复机制（日志）
  * 一致性：用户负责
  * 隔离性：并发控制机制（各种锁）
  * 持久性：恢复机制
* 事务隔离性级别
  * read uncommitted：会发生脏读
  * read committed：会发生不可重复读
  * repeatable read：同一记录的两次读取之间不能有事务修改，会发生幻象
  * serializable：等价于串行调度
* 处理冲突：调度
* 冲突可串行化判定
* 视图可串行化判定


#### 网络资料
* 参考资料
  * https://juejin.im/post/5a9ca0d6518825555c1d1acd
  * https://www.open-open.com/lib/view/open1452046967245.html
  * https://juejin.im/post/5b55b842f265da0f9e589e79
* 存储过程的优缺点
  * 优点：执行效率高
  * 缺点：不同数据库语法不同
* 视图：虚表
* 乐观锁
  * 假设不会发生并发冲突，只在提交操作时检查是否违反数据完整性
  * **在修改数据的时候把事务锁起来，通过version的方式来进行锁定**
  * 实现方式：使用version版本或者时间戳
  * 优点：不会产生任何锁和死锁
  * 缺点：会遇到不可预期的结果
* 悲观锁
  * 假定会发生并发冲突，屏蔽一切可能违反数据完整性的操作
  * **在查询完数据的时候就把事务锁起来，直到提交事务**
  * 实现方式：使用数据库中的锁机制
  * 优点：提供安全保证，先取锁再访问，在对任意记录进行修改前，先尝试为该记录加上排他锁
  * 缺点：会产生额外开销，增加产生死锁的机会，降低并行化
* 索引
  * 提高检索速度
    * 底层数据结构：B+树O(logn)
  * 降低增删改速度
    * B+树是一颗平衡树，增删改会破坏原有结构，维持平衡所做的工作就是额外的开销
  * 哈希索引
    * InnoDB是自适应哈希索引
    * 优点：速度快O(1)
    * 缺点
      * 没办法利用索引完成排序
      * 不支持最左匹配原则
      * 哈希碰撞
      * 不支持范围查询
  * 聚集索引
    * 以主键创建的索引
    * 叶子节点存储的是表中的数据
  * 非聚集索引
    * 以非主键创建的索引
    * 叶子节点存储的是主键和索引列
    * 查询出数据时，拿到叶子上的主键再去查到想要查找的数据，需要回表
  * 覆盖索引
    * 查询出的列和索引是对应的，不做回表操作
  * 最左匹配原则
    * 自动优化顺序
* 锁
  * <img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb68hg6z3j30m80a2dg6.jpg" style="zoom:67%;" />
  * 表锁
    * 表读锁、表写锁
      * 读读不阻塞，读写阻塞，写写阻塞
    * 开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突概率高，并发度最低
  * 行锁
    * 共享锁（S锁）
    * 排他锁（X锁)
    * 为了允许行锁和表锁共存，实现多粒度锁机制，引入意向锁（表锁）
      * 意向共享锁（IS）
      * 意向排他锁（IX）
    * 开销大，加锁慢；会出现死锁；锁定粒度小，发生锁冲突的概率低，并发度高
  * InnoDB
    * 行锁和表锁都支持，InnoDB只有通过**索引条件**检索数据**才使用行级锁**，否则，InnoDB将使用**表锁**
  * MyISAM
    * 只支持表锁
  * MVCC
    * 行级锁的升级版
    * 读写不阻塞
    * 通过快照提供一定级别的一致性读取，提供同一数据的不同版本
      * 语句级：针对Read committed
      * 事务级：针对Repeatable read